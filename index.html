<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>كشف الحضور الذكي - كلية التمريض</title>
    
    <meta property="og:title" content="جامعة الريادة - كلية التمريض">
    <meta property="og:description" content="نظام تسجيل الحضور الذكي.">
    <meta property="og:image" content="https://k.top4top.io/p_3615d3vek1.png">
    
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" href="icon.png" type="image/png">
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=Outfit:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <style>
        /* === الأساسيات والألوان العصرية (تعديل: ألوان مريحة للعين) === */
        :root { 
            --primary: #0ea5e9; --primary-dark: #0284c7; 
            --text-main: #1e293b; --text-sub: #64748b; 
            --glass-bg: rgba(255, 255, 255, 0.95); 
            --danger: #ef4444; --success: #10b981; --warning: #f59e0b; 
            /* ألوان لوحة التحكم الجديدة */
            --admin-dark: #1e293b; --admin-red: #be123c; --admin-green: #047857; 
            --admin-purple: #6d28d9; --admin-orange: #b45309; --admin-teal: #0f766e;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        html { background-color: #0f172a !important; height: 100vh; overflow-y: auto; overflow-x: hidden; }
        
        body { 
            font-family: 'Cairo', sans-serif; 
            min-height: 100vh; width: 100%; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; color: var(--text-main); 
            background-color: transparent !important; position: relative; 
            padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); 
            transition: all 0.3s;
        }

        /* (تعديل: رفع النافذة عند فتح الكيبورد) */
        body.keyboard-open #identityAlertModal .modal-box {
            transform: translateY(-20%) !important;
        }
        
        .bg-image { background: url('https://a.top4top.io/p_36115ao3o1.jpg') no-repeat center center; background-size: cover; filter: blur(12px) brightness(0.9); transform: scale(1.2); z-index: -1; position: fixed; top: -10vh; left: -10vw; width: 120vw; height: 120vh; pointer-events: none; }
        
        .app-card { 
            background: var(--glass-bg); width: 90%; max-width: 400px; border-radius: 24px; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); text-align: center; 
            position: relative; overflow: hidden; animation: slideUp 0.6s ease-out; 
            margin: 20px auto; min-height: 650px; display: flex; flex-direction: column; 
        }

        /* === تحسين أزرار المسؤول (تعديل 4) === */
        .admin-controls-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px; padding: 0 10px; }
        
        .admin-sub-btn { 
            border-radius: 16px; padding: 0; height: 70px; border: none; cursor: pointer; 
            font-family: 'Cairo'; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; 
            color: white; font-weight: 700; font-size: 11px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); position: relative; overflow: hidden;
        }
        .admin-sub-btn i { font-size: 20px; margin-bottom: 2px; }
        .admin-sub-btn:active { transform: scale(0.95); opacity: 0.9; }

        /* الألوان الجديدة */
        .btn-admin-login { grid-column: span 4; background: linear-gradient(145deg, #334155, #0f172a); height: 50px; flex-direction: row; font-size: 14px; gap: 10px; } 
        .btn-admin-logout { grid-column: span 1; background: linear-gradient(145deg, var(--admin-red), #9f1239); }
        .btn-report { grid-column: span 1; background: linear-gradient(145deg, var(--admin-green), #065f46); }
        .btn-report.locked { background: #f1f5f9; color: #94a3b8; cursor: not-allowed; box-shadow: none; }
        .btn-exams { grid-column: span 1; background: linear-gradient(145deg, var(--admin-purple), #5b21b6); }
        .btn-refresh { grid-column: span 1; background: linear-gradient(145deg, var(--admin-orange), #92400e); }
        .btn-data-entry { grid-column: span 4; background: linear-gradient(145deg, var(--admin-teal), #115e59); height: 50px; flex-direction: row; font-size: 14px; gap: 10px; margin-top: 5px; }

        /* === نافذة التنبيهات المتطورة (تعديل 2) === */
        #identityAlertModal .modal-box {
            padding: 0; background: #f8fafc; border-radius: 20px; overflow: hidden; max-height: 80vh; display: flex; flex-direction: column;
        }
        .alert-header-modern {
            padding: 15px; background: white; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;
        }
        .alert-list-modern {
            flex: 1; overflow-y: auto; padding: 10px;
        }
        .alert-card {
            background: white; border-radius: 12px; padding: 12px; margin-bottom: 8px;
            border-right: 4px solid #cbd5e1; box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            transition: 0.2s; text-align: right;
        }
        .alert-card.type-repeat { border-right-color: #ef4444; background: #fef2f2; }
        .alert-card.type-far { border-right-color: #f59e0b; background: #fffbeb; }
        .alert-meta { display: flex; justify-content: space-between; font-size: 10px; color: #94a3b8; margin-top: 5px; font-family: 'Outfit', sans-serif; direction: ltr; }
        .alert-reason-badge {
            font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; display: inline-block; margin-top: 4px;
        }
        
        /* === نافذة GPS الإجبارية (تعديل 10) === */
        #gpsStrictModal { z-index: 2147483647 !important; background: rgba(15, 23, 42, 0.98); }
        #gpsStrictModal .modal-box { border: 2px solid #ef4444; background: #1e293b; color: white; width: 85%; max-width: 300px; padding: 25px; }
        .gps-pulse { animation: pulse-red 1.5s infinite; color: #ef4444; font-size: 40px; margin-bottom: 15px; }

        /* === تصميم قوائم الإدخال الحديثة (تعديل 5) === */
        .manage-card { background: white; border-radius: 16px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.03); border: 1px solid #e2e8f0; }
        .manage-input-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .manage-input { flex: 1; padding: 10px; border: 1px solid #e2e8f0; border-radius: 10px; font-family: 'Cairo'; outline: none; background: #f8fafc; }
        .btn-add-modern { background: #ecfdf5; color: #059669; border: 1px solid #10b981; padding: 10px 15px; border-radius: 10px; cursor: pointer; font-weight: bold; white-space: nowrap; }
        .btn-add-modern:active { transform: scale(0.95); }
        .list-item-modern { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #f1f5f9; background: white; }
        .btn-delete-modern { width: 32px; height: 32px; border-radius: 8px; background: #fee2e2; color: #ef4444; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .btn-delete-modern:active { transform: scale(0.9); background: #ef4444; color: white; }
        
        .manage-btn-modern {
            width: 100%; padding: 15px; border-radius: 16px; border: none; cursor: pointer;
            font-family: 'Cairo'; font-weight: 700; font-size: 14px; display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: 0.2s; background: white; border: 1px solid #e2e8f0;
        }
        .manage-btn-modern:active { transform: scale(0.98); background: #f8fafc; }
        .manage-btn-modern i { font-size: 18px; color: var(--primary); }

        /* === زر الإغلاق الموحد للقوائم (تعديل 9) === */
        .close-btn-floating {
            position: absolute; left: 15px; top: 15px; width: 30px; height: 30px; 
            background: #f1f5f9; color: #64748b; border-radius: 50%; display: flex; 
            align-items: center; justify-content: center; cursor: pointer; z-index: 50;
            transition: 0.2s; font-size: 14px;
        }
        .close-btn-floating:active { transform: scale(0.9); background: #e2e8f0; }

        /* === باقي الستايلات الأساسية === */
        .section { display: none; opacity: 0; transition: opacity 0.3s ease; width: 100%; } 
        .section.active { display: block; opacity: 1; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes pulse-red { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* مودال الحظر (تعديل 7) */
        #banModal { z-index: 2147483647; background: black; }
        #banModal .modal-box { border: 2px solid #ef4444; background: #1a0505; color: white; }
        
        .btn-refresh-list { background: linear-gradient(135deg, #0ea5e9, #0284c7); color: white; width: 100%; padding: 14px; border-radius: 16px; border: none; cursor: pointer; font-family: 'Cairo'; display: flex; align-items: center; justify-content: center; gap: 8px; }

        .input-group { margin-bottom: 15px; position: relative; width: 100%; }
        .modern-input { width: 100%; padding: 12px 15px; border: 2px solid #e2e8f0; border-radius: 12px; font-family: 'Cairo'; outline: none; background: #f8fafc; text-align: right; }
        .btn-main { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; width: 100%; padding: 15px; border-radius: 20px; font-size: 16px; font-weight: 800; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 15px; box-shadow: 0 8px 20px -5px rgba(14, 165, 233, 0.4); }
        .btn-secondary { background: white; color: var(--text-sub); border: 2px solid #e2e8f0; width: 100%; padding: 12px; border-radius: 14px; cursor: pointer; font-family: 'Cairo'; font-weight: 700; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); z-index: 9999; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-box { background: rgba(255, 255, 255, 0.95); width: 85%; max-width: 350px; padding: 25px; border-radius: 24px; text-align: center; box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2); animation: popUp 0.3s; position: relative; }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Custom Select */
        .custom-select-wrapper { position: relative; width: 100%; margin-bottom: 15px; }
        .custom-select-trigger { padding: 15px; background: white; border: 1px solid #e2e8f0; border-radius: 16px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .custom-options { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-radius: 24px 24px 0 0; padding: 20px; z-index: 10000; transform: translateY(100%); transition: transform 0.3s; max-height: 60vh; overflow-y: auto; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); }
        .custom-select-wrapper.open .custom-options { transform: translateY(0); }
        .custom-option { padding: 15px; border-bottom: 1px solid #f1f5f9; cursor: pointer; display: flex; justify-content: space-between; }
        .custom-option.selected { color: var(--primary); font-weight: bold; background: #f0f9ff; border-radius: 10px; }
        .custom-options-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: none; }
        .custom-select-wrapper.open .custom-options-overlay { display: block; }
        
        .report-views-container { position: relative; width: 100%; height: 100%; overflow: hidden; }
        .report-view { position: absolute; top:0; left:0; width:100%; height:100%; transition: transform 0.3s ease; background: #f8fafc; overflow-y: auto; padding: 10px; }
        .slide-in { transform: translateX(0); } .slide-out-left { transform: translateX(-100%); } .slide-out-right { transform: translateX(100%); }
        .subject-big-card, .hall-big-card { background: white; border-radius: 20px; padding: 20px; margin-bottom: 15px; cursor: pointer; border: 1px solid #e2e8f0; box-shadow: 0 5px 15px rgba(0,0,0,0.03); display: flex; align-items: center; justify-content: space-between; }
        .student-detailed-card { background: white; border-radius: 14px; padding: 15px; margin-bottom: 10px; border: 1px solid #f1f5f9; }
        .card-banner { width: 100%; height: 140px; background: url('https://a.top4top.io/p_36115ao3o1.jpg') no-repeat center center; background-size: cover; position: relative; border-radius: 24px 24px 0 0; overflow: hidden; z-index: 2; flex-shrink: 0; }
        .card-body { padding: 0 25px 30px 25px; position: relative; z-index: 2; flex: 1; display: flex; flex-direction: column; }
        
        .hero-icon-wrapper { width: 110px; height: 110px; margin: -65px auto 20px auto; position: relative; z-index: 10; border-radius: 50%; background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(10px); border: 2px solid rgba(255, 255, 255, 0.6); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15); overflow: hidden; animation: float-magic 4s ease-in-out infinite alternate; }
        .hero-img { width: 100%; height: 100%; object-fit: cover; transform: scale(0.94); border-radius: 50%; }
        .status-icon-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(5px); opacity: 0; transform: scale(0); transition: 0.4s; border-radius: 50%; z-index: 3; }
        .hero-icon-wrapper.show-icon .hero-img { transform: scale(0); opacity: 0; }
        .hero-icon-wrapper.show-icon .status-icon-container { opacity: 1; transform: scale(1); }
        .hero-icon { font-size: 42px; color: var(--primary); }
        @keyframes float-magic { 0% { transform: translateY(0); } 100% { transform: translateY(-12px); } }
    </style>
</head>
<body>
    <div id="desktop-blocker" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#0f172a; color:#ef4444; z-index:2147483647; display:none; flex-direction:column; align-items:center; justify-content:center; text-align:center;">
        <i class="fa-solid fa-mobile-screen-button" style="font-size:50px; margin-bottom:20px;"></i>
        <h2>عذراً، وصول غير مصرح به</h2>
        <p>النظام متاح فقط من الهواتف الذكية.</p>
    </div>

    <div id="gpsStrictModal" class="modal-overlay">
        <div class="modal-box">
            <i class="fa-solid fa-location-dot gps-pulse"></i>
            <div class="modal-title" style="color:#ef4444; font-weight:900; font-size:18px; margin-bottom:10px;">الموقع مطلوب إجبارياً</div>
            <div class="modal-text" style="color:#94a3b8; font-size:13px; margin-bottom:20px;">
                لقد قمت بإيقاف الموقع. لا يمكن للنظام العمل بدونه.<br>قم بتفعيله الآن ثم اضغط زر التحديث.
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="document.getElementById('gpsStrictModal').style.display='none'" class="btn-secondary" style="flex:1; background:transparent; color:#94a3b8; border:1px solid #475569;">إغلاق</button>
                <button onclick="forceRetryGPS()" class="btn-main" style="background:#ef4444; color:white; margin-bottom:0; flex:2;">
                    تفعيل وإعادة المحاولة <i class="fa-solid fa-rotate-right"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="banModal" class="modal-overlay" style="z-index: 999999;">
        <div class="modal-box" style="background:#1a0505; border:2px solid #ef4444;">
            <i class="fa-solid fa-ban" style="font-size:50px; color:#ef4444; margin-bottom:15px;"></i>
            <h2 style="color:#ef4444; margin-bottom:10px;">تم حظرك اليوم</h2>
            <p style="font-size:13px; color:white; line-height:1.6;">لقد استنفذت المحاولات المسموحة (3) أو خالفت سياسات النظام (تكرار/غش).<br>حاول مجدداً غداً.</p>
        </div>
    </div>

    <div id="identityAlertModal" class="modal-overlay" style="z-index: 90000;">
        <div class="modal-box">
            <div class="alert-header-modern">
                <h3 style="font-size:16px; margin:0;">سجل التنبيهات</h3>
                <div onclick="closeIdentityAlert()" class="close-btn-floating" style="position:static;"><i class="fa-solid fa-xmark"></i></div>
            </div>
            <div id="alertsListContainer" class="alert-list-modern">
                </div>
        </div>
    </div>

    <div class="bg-image"></div>
    <audio id="successSound" src="https://www.soundjay.com/buttons/sounds/button-3.mp3"></audio>
    <audio id="clickSound" src="https://www.soundjay.com/buttons/sounds/button-16.mp3"></audio>
    <audio id="beepSound" src="https://www.soundjay.com/buttons/sounds/beep-07.mp3"></audio>

    <div class="app-card">
        <div class="card-banner"></div>
        <div id="adminBadge" style="position:absolute; top:15px; left:50%; transform:translateX(-50%); background:#ef4444; color:white; padding:4px 12px; border-radius:20px; font-size:10px; font-weight:bold; display:none; z-index:100;">وضع المسؤول</div>
        
        <div id="notificationBtn" onclick="showNotificationModal()" style="position:absolute; top:20px; left:20px; width:40px; height:40px; background:rgba(255,255,255,0.8); border-radius:50%; display:flex; align-items:center; justify-content:center; z-index:50; cursor:pointer; color:#64748b;">
            <i class="fa-solid fa-bell"></i>
            <div id="notifBadge" style="position:absolute; top:8px; right:8px; width:8px; height:8px; background:#ef4444; border-radius:50%; display:none;"></div>
        </div>

        <div class="card-body">
            <div class="hero-icon-wrapper" id="heroIconWrapper">
                <img src="https://k.top4top.io/p_3615d3vek1.png" class="hero-img" id="heroImage">
                <div class="status-icon-container" id="statusIconContainer">
                    <i class="fa-solid fa-user-nurse hero-icon" id="statusIcon"></i>
                </div>
            </div>

            <div style="text-align:center; font-family:'Outfit'; font-size:11px; color:#64748b; margin-bottom:15px; direction:ltr;">
                <span id="currentTime">--:--</span> | <span id="currentDate">--/--</span>
            </div>

            <div id="screenWelcome" class="section active">
                <h1 style="font-size:22px; margin-bottom:5px;">كشف الحضور الذكي</h1>
                <p style="font-size:13px; color:#64748b; margin-bottom:25px;">جامعة الريادة - كلية التمريض</p>
                
                <button onclick="startProcess()" class="btn-main" id="mainActionBtn">
                    تسجيل الحضور <i class="fa-solid fa-fingerprint"></i>
                </button>

                <div class="admin-controls-grid">
                    <button id="btnLoginConfig" onclick="switchScreen('screenAdminLogin')" class="admin-sub-btn btn-admin-login">
                        <i class="fa-solid fa-user-gear"></i> دخول المسؤول
                    </button>
                    
                    <button id="btnLogoutConfig" onclick="performLogout()" class="admin-sub-btn btn-admin-logout" style="display:none;">
                        <i class="fa-solid fa-power-off"></i> خروج
                    </button>
                    <button id="btnReportConfig" onclick="openReportModal()" class="admin-sub-btn btn-report locked">
                        <i class="fa-solid fa-clipboard-list"></i> السجل
                    </button>
                    <button id="btnExamsConfig" onclick="openExamModal()" class="admin-sub-btn btn-exams" style="display:none;">
                        <i class="fa-solid fa-pen-to-square"></i> امتحانات
                    </button>
                    <button id="btnRefreshConfig" onclick="location.reload()" class="admin-sub-btn btn-refresh" style="display:none;">
                        <i class="fa-solid fa-rotate"></i>
                    </button>
                    
                    <button id="btnDataEntryConfig" onclick="openDataEntryMenu()" class="admin-sub-btn btn-data-entry" style="display:none;">
                        <i class="fa-solid fa-database"></i> إدارة البيانات
                    </button>
                </div>
                
                <div id="attemptsDisplay" style="margin-top:10px; font-size:11px; color:#ef4444; font-weight:bold;">
                    </div>
            </div>

            <div id="screenAdminLogin" class="section">
                <h2>دخول المسؤول</h2>
                <input type="password" id="adminPassword" class="modern-input" placeholder="كلمة المرور" style="margin:20px 0;">
                <button onclick="checkAdminPassword()" class="btn-main">دخول</button>
                <button onclick="switchScreen('screenWelcome')" class="btn-secondary">إلغاء</button>
            </div>

            <div id="screenLoading" class="section">
                <i class="fa-solid fa-circle-notch fa-spin" style="font-size:40px; color:var(--primary); margin:30px 0;"></i>
                <h3>جاري التحقق...</h3>
                <p>يرجى الانتظار، جاري تحديد الموقع.</p>
            </div>

            <div id="screenScanQR" class="section">
                <h3>بيانات الحضور</h3>
                
                <div class="custom-select-wrapper" id="yearSelectWrapper">
                    <div class="custom-select-trigger">
                        <div class="trigger-content"><span class="trigger-text">-- اختر الفرقة --</span></div>
                        <i class="fa-solid fa-chevron-down"></i>
                    </div>
                    <div class="custom-options-overlay" onclick="closeSelect(this)"></div>
                    <div class="custom-options">
                        <div class="close-btn-floating" onclick="closeSelectFromBtn(this)"><i class="fa-solid fa-xmark"></i></div>
                        <div class="options-title">الفرقة الدراسية</div>
                        <div class="custom-option" data-value="first_year"><span>الفرقة الأولى</span></div>
                        <div class="custom-option" data-value="second_year"><span>الفرقة الثانية</span></div>
                    </div>
                    <select id="yearSelect" style="display:none;"></select>
                </div>

                <div class="custom-select-wrapper disabled" id="subjectSelectWrapper">
                    <div class="custom-select-trigger">
                        <div class="trigger-content"><span class="trigger-text">-- المادة --</span></div>
                        <i class="fa-solid fa-chevron-down"></i>
                    </div>
                    <div class="custom-options-overlay" onclick="closeSelect(this)"></div>
                    <div class="custom-options">
                        <div class="close-btn-floating" onclick="closeSelectFromBtn(this)"><i class="fa-solid fa-xmark"></i></div>
                        <div class="options-title">المادة الدراسية</div>
                        <div id="subjectOptionsContainer"></div>
                    </div>
                    <select id="subjectSelect" style="display:none;"></select>
                </div>

                <div class="custom-select-wrapper" id="hallSelectWrapper">
                    <div class="custom-select-trigger">
                        <div class="trigger-content"><span class="trigger-text">-- المدرج (إجباري) --</span></div>
                        <i class="fa-solid fa-chevron-down"></i>
                    </div>
                    <div class="custom-options-overlay" onclick="closeSelect(this)"></div>
                    <div class="custom-options">
                        <div class="close-btn-floating" onclick="closeSelectFromBtn(this)"><i class="fa-solid fa-xmark"></i></div>
                        <div class="options-title">اختر المدرج</div>
                        <div class="hall-search-box">
                            <input type="text" id="hallSearchInput" class="hall-search-input" placeholder="بحث عن القاعة..." onclick="event.stopPropagation()">
                        </div>
                        <div id="hallOptionsContainer" style="max-height:200px; overflow-y:auto;"></div>
                    </div>
                    <select id="hallSelect" style="display:none;"></select>
                </div>

                <div id="qr-reader" style="width:100%; border-radius:15px; overflow:hidden; display:none; margin-bottom:15px;"></div>
                <div id="startScanCard" onclick="startQrScanner()" style="border:2px dashed #cbd5e1; border-radius:15px; padding:20px; cursor:pointer; margin-bottom:15px;">
                    <i class="fa-solid fa-camera" style="font-size:24px; color:var(--primary);"></i>
                    <div style="font-weight:bold; margin-top:5px;">اضغط لمسح الكود</div>
                </div>

                <button onclick="startFaceVerificationProcess()" class="btn-main" id="btnVerify" disabled style="opacity:0.6; cursor:not-allowed;">
                    <i class="fa-solid fa-face-viewfinder"></i> التحقق من الهوية
                </button>
                <div style="font-size:11px; color:#ef4444; display:none; margin-top:5px;" id="hallErrorMsg">* يجب اختيار المدرج أولاً</div>

                <input type="hidden" id="sessionPass">
            </div>

            <div id="screenFaceCheck" class="section">
                <h2>التعرف على الوجه</h2>
                <div class="cam-container" id="camBorder" style="width:200px; height:200px; border-radius:50%; overflow:hidden; margin:20px auto; border:4px solid #e2e8f0; position:relative;">
                    <video id="video" autoplay muted playsinline style="width:100%; height:100%; object-fit:cover; transform:scaleX(-1);"></video>
                </div>
                <h3 id="statusTxt" style="color:#0ea5e9;">جاري التشغيل...</h3>
            </div>

            <div id="screenSuccess" class="section">
                <i class="fa-solid fa-circle-check" style="font-size:60px; color:#10b981; margin:20px 0;"></i>
                <h2 style="color:#10b981;">تم التسجيل بنجاح</h2>
                <div class="ticket-container" style="background:#f8fafc; border:1px solid #e2e8f0; padding:15px; border-radius:15px; margin-top:20px; text-align:left;">
                    <div class="t-row"><span class="t-label">Name:</span> <span id="receiptName" style="font-weight:bold;">--</span></div>
                    <div class="t-row"><span class="t-label">ID:</span> <span id="receiptID" style="font-family:'Outfit';">--</span></div>
                    <div class="t-row"><span class="t-label">Hall:</span> <span id="receiptHall" style="font-weight:bold; color:#0ea5e9;">--</span></div>
                    <div class="t-row"><span class="t-label">Time:</span> <span id="receiptTime" style="font-family:'Outfit';">--</span></div>
                </div>
                <button onclick="location.reload()" class="btn-main" style="margin-top:20px;">إنهاء</button>
            </div>
            
            <div id="screenError" class="section">
                <i class="fa-solid fa-triangle-exclamation" style="font-size:50px; color:#ef4444; margin:20px 0;"></i>
                <h2 style="color:#ef4444;">تنبيه</h2>
                <p id="errorMsg">حدث خطأ.</p>
                <button onclick="location.reload()" class="btn-secondary" style="margin-top:15px;">إعادة المحاولة</button>
            </div>
        </div>
    </div>

    <div id="dataEntryModal" class="modal-overlay">
        <div class="modal-box">
            <div class="close-btn-floating" onclick="document.getElementById('dataEntryModal').style.display='none'"><i class="fa-solid fa-xmark"></i></div>
            <h3>إدارة النظام</h3>
            <div style="display:grid; grid-template-columns:1fr; gap:10px; margin-top:15px;">
                <button onclick="openManageHalls()" class="manage-btn-modern"><span>إدارة القاعات</span> <i class="fa-solid fa-building"></i></button>
                <button onclick="openManageSubjects()" class="manage-btn-modern"><span>إدارة المواد</span> <i class="fa-solid fa-book"></i></button>
                <button onclick="openManageStudents()" class="manage-btn-modern" style="background:#eff6ff; color:#1d4ed8; border-color:#bfdbfe;">
                    <span>إدارة الطلاب (جديد)</span> <i class="fa-solid fa-user-plus"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="manageHallsModal" class="modal-overlay"><div class="modal-box" id="manageHallsContent"></div></div>
    <div id="manageSubjectsModal" class="modal-overlay"><div class="modal-box" id="manageSubjectsContent"></div></div>
    <div id="manageStudentsModal" class="modal-overlay"><div class="modal-box" id="manageStudentsContent"></div></div>
    <div id="modernConfirmModal" class="modal-overlay"><div class="modal-box" id="confirmModalContent"></div></div>
    
    <div id="reportModal" class="modal-overlay">
        <div class="modal-box" style="height:85vh; padding:0; display:flex; flex-direction:column;">
            <div class="alert-header-modern">
                <div style="display:flex; flex-direction:column; align-items:flex-start;">
                    <h3 style="margin:0;">سجل الحضور</h3>
                    <div id="reportDateDisplay" style="font-size:11px; color:#94a3b8;">--</div>
                </div>
                <div class="close-btn-floating" onclick="document.getElementById('reportModal').style.display='none'" style="position:static;"><i class="fa-solid fa-xmark"></i></div>
            </div>
            <div class="report-views-container">
                <div id="viewSubjects" class="report-view slide-in"><div id="subjectsContainer"></div></div>
                <div id="viewHalls" class="report-view"><div id="hallsContainer"></div></div>
                <div id="viewStudents" class="report-view"><div id="studentsContainer"></div></div>
            </div>
            <div style="padding:10px; border-top:1px solid #e2e8f0;">
                <button onclick="refreshCurrentReport()" class="btn-refresh-list">تحديث <i class="fa-solid fa-rotate"></i></button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        // ============================================================
        // 1. الإعدادات والروابط (تم التحديث - طلب أول)
        // ============================================================
        const CONFIG = {
            // شيت الحضور العادي
            sheetApiUrl: "https://script.google.com/macros/s/AKfycbz5ywIwwwwVOEYSwA7Ldgxq-kkbpMBPJ6mnR-cvB5K2BzMXrXgw5Z-6rkMSDniW8qtI/exec",
            // شيت الهوية الجديد (الأمني)
            identitySheetUrl: "https://script.google.com/macros/s/AKfycbyiW8lPdWwuOv4G3fu2GT87t7QNxjXU064PNrq_a8_PyAchEcWxXSO3F77b0hr9v84t/exec",
            
            adminPassword: "RYADA",
            modelsUrl: 'https://justadudewhohacks.github.io/face-api.js/models',
            gps: { targetLat: 30.38585, targetLong: 30.48885, allowedDistanceKm: 1.5 } 
        };

        const STORAGE_KEYS = {
            DB: "offline_students_db_v6",
            HALLS: "halls_list_v6",
            SUBJECTS: "subjects_data_v6",
            ALERTS: "system_alerts_log_v6",
            ATTEMPTS: "daily_attempts_v6_" + new Date().toLocaleDateString('en-GB'),
            IS_BANNED: "is_banned_today_v6_" + new Date().toLocaleDateString('en-GB')
        };

        let studentsDB = {};
        let attendanceData = {};
        let systemAlerts = [];
        let html5QrCode;
        let videoStream = null;
        let isProcessActive = false; 
        
        // Report State
        let cachedReportData = [];
        let currentReportView = 'subjects'; 
        let currentSelectedSubject = '';
        let currentSelectedHall = '';

        let defaultHalls = ["037", "038", "039", "019", "025", "123", "124", "127", "131", "132"];
        let hallsList = JSON.parse(localStorage.getItem(STORAGE_KEYS.HALLS)) || defaultHalls;

        let defaultSubjects = {
            "first_year": ["تمريض بالغين", "اناتومى", "فسيولوجى", "ميكروبيولوجي", "انجليزي"],
            "second_year": ["حالات حرجة", "اطفال", "نسا", "صحة مجتمع", "ادارة"]
        };
        let subjectsData = JSON.parse(localStorage.getItem(STORAGE_KEYS.SUBJECTS)) || defaultSubjects;

        window.onload = function() {
            if(checkBanStatus()) return;
            loadLocalData();
            updateUIForMode();
            setupSelectListeners();
            startClock();
            
            fetch(CONFIG.sheetApiUrl).then(r => r.json()).then(d => {
                if(!d.error) { studentsDB = d; localStorage.setItem(STORAGE_KEYS.DB, JSON.stringify(d)); }
            }).catch(e => console.log("Offline Mode"));
            
            // تهيئة واجهة إدارة القاعات
            document.getElementById('hallSearchInput').addEventListener('input', function(e) { renderHallOptions(e.target.value); });
        };

        function startClock() {
            setInterval(() => {
                const now = new Date();
                document.getElementById('currentTime').innerText = now.toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit'});
                document.getElementById('currentDate').innerText = now.toLocaleDateString('en-US');
            }, 1000);
        }

        function loadLocalData() {
            const savedDB = localStorage.getItem(STORAGE_KEYS.DB);
            if (savedDB) studentsDB = JSON.parse(savedDB);
            
            const savedAlerts = localStorage.getItem(STORAGE_KEYS.ALERTS);
            if (savedAlerts) systemAlerts = JSON.parse(savedAlerts);
            updateAlertBadge();
        }

        // ============================================================
        // 3. نظام الحظر الصارم (تعديل 7: 3 محاولات + حظر نهائي)
        // ============================================================
        function checkBanStatus() {
            const isBanned = localStorage.getItem(STORAGE_KEYS.IS_BANNED);
            if (isBanned === 'true') {
                document.getElementById('banModal').style.display = 'flex';
                document.body.style.overflow = 'hidden'; 
                return true;
            }
            updateAttemptsUI();
            return false;
        }

        function getAttempts() {
            return parseInt(localStorage.getItem(STORAGE_KEYS.ATTEMPTS) || "3");
        }

        function deductAttempt() {
            // لا نخصم للمسؤول
            if (sessionStorage.getItem('DOCTOR_MODE') === 'true') return;

            let current = getAttempts();
            current--;
            localStorage.setItem(STORAGE_KEYS.ATTEMPTS, current);
            
            if (current <= 0) {
                localStorage.setItem(STORAGE_KEYS.IS_BANNED, 'true');
                checkBanStatus();
            } else {
                updateAttemptsUI();
                showToast(`⚠️ تبقى لك ${current} محاولات فقط اليوم`, 3000, '#ef4444');
            }
        }

        function updateAttemptsUI() {
            const div = document.getElementById('attemptsDisplay');
            const left = getAttempts();
            let hearts = '';
            for(let i=0; i<left; i++) hearts += '<i class="fa-solid fa-heart"></i> ';
            div.innerHTML = `المحاولات: ${hearts}`;
        }

        // مراقبة الخروج من التطبيق (تعديل 7)
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden' && isProcessActive) {
                deductAttempt();
                location.reload(); 
            }
        });

        // منع الرجوع للخلف أثناء التسجيل (تعديل 7)
        window.history.pushState(null, null, window.location.href);
        window.onpopstate = function () {
            if (isProcessActive) {
                deductAttempt();
                location.reload();
            } else {
                window.history.pushState(null, null, window.location.href);
            }
        };

        // ============================================================
        // 4. نظام GPS الإجباري (تعديل 1 + 10)
        // ============================================================
        let userLat = null, userLng = null;

        function checkLocationStrict(force = false) {
            if (!navigator.geolocation) {
                document.getElementById('gpsStrictModal').style.display = 'flex';
                return;
            }
            const options = { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 };
            
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    userLat = pos.coords.latitude;
                    userLng = pos.coords.longitude;
                    document.getElementById('gpsStrictModal').style.display = 'none';
                    if (force) showToast("تم تحديد الموقع بنجاح", 2000, "#10b981");
                },
                (err) => {
                    document.getElementById('gpsStrictModal').style.display = 'flex';
                },
                options
            );
        }

        function forceRetryGPS() {
            checkLocationStrict(true);
        }

        function startGPSWatcher() {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition((p) => { userLat = p.coords.latitude; userLng = p.coords.longitude; }, (e) => {});
            }
        }

        // ============================================================
        // 5. سير العمل (Workflow) & QR
        // ============================================================
        function startProcess() {
            if (checkBanStatus()) return;
            if (!userLat) {
                checkLocationStrict();
                setTimeout(() => { if(userLat) _proceedStart(); }, 1500);
            } else {
                _proceedStart();
            }
        }

        function _proceedStart() {
            isProcessActive = true;
            attendanceData = {};
            document.getElementById('sessionPass').value = '';
            document.getElementById('hallErrorMsg').style.display = 'none';
            
            // إعادة ضبط القوائم
            document.querySelectorAll('.custom-select-wrapper').forEach(w => w.classList.remove('open'));
            document.getElementById('yearSelect').value = '';
            document.getElementById('subjectSelect').value = '';
            document.getElementById('hallSelect').value = '';
            document.querySelector('#yearSelectWrapper .trigger-text').textContent = '-- اختر الفرقة --';
            document.querySelector('#subjectSelectWrapper .trigger-text').textContent = '-- المادة --';
            document.querySelector('#subjectSelectWrapper').classList.add('disabled');
            document.querySelector('#hallSelectWrapper .trigger-text').textContent = '-- المدرج --';
            
            switchScreen('screenLoading');
            setTimeout(() => {
                switchScreen('screenScanQR');
                startQrScanner();
            }, 1000);
        }

        function startQrScanner() {
            document.getElementById('startScanCard').style.display = 'none';
            document.getElementById('qr-reader').style.display = 'block';
            
            if(html5QrCode) { try{ html5QrCode.stop(); }catch(e){} }
            html5QrCode = new Html5Qrcode("qr-reader");
            
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 },
                (decodedText) => {
                    html5QrCode.stop().then(() => {
                        document.getElementById('qr-reader').style.display = 'none';
                        document.getElementById('startScanCard').innerHTML = `<div style="color:#10b981; font-weight:bold;"><i class="fa-solid fa-check-circle"></i> تم مسح الكود</div>`;
                        document.getElementById('startScanCard').style.display = 'block';
                        document.getElementById('sessionPass').value = decodedText;
                        checkAllConditions();
                        document.getElementById('successSound').play();
                    });
                },
                (errorMessage) => {}
            ).catch(err => { alert("يرجى السماح للكاميرا"); });
        }

        // التحقق من الشروط (تعديل 8: المدرج إجباري)
        function checkAllConditions() {
            const year = document.getElementById('yearSelect').value;
            const sub = document.getElementById('subjectSelect').value;
            const hall = document.getElementById('hallSelect').value;
            const pass = document.getElementById('sessionPass').value;
            const btn = document.getElementById('btnVerify');
            const hallMsg = document.getElementById('hallErrorMsg');

            if (!hall) hallMsg.style.display = 'block'; else hallMsg.style.display = 'none';

            if (year && sub && hall && pass) {
                btn.disabled = false;
                btn.style.opacity = "1";
                btn.style.cursor = "pointer";
            } else {
                btn.disabled = true;
                btn.style.opacity = "0.6";
                btn.style.cursor = "not-allowed";
            }
        }

        // ============================================================
        // 6. بصمة الوجه والإرسال (Face ID & Submit)
        // ============================================================
        async function startFaceVerificationProcess() {
            if (html5QrCode && html5QrCode.isScanning) await html5QrCode.stop();
            switchScreen('screenFaceCheck');
            
            const video = document.getElementById('video');
            const statusTxt = document.getElementById('statusTxt');

            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri(CONFIG.modelsUrl),
                faceapi.nets.faceLandmark68Net.loadFromUri(CONFIG.modelsUrl),
                faceapi.nets.faceRecognitionNet.loadFromUri(CONFIG.modelsUrl)
            ]);

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                video.srcObject = stream;
                videoStream = stream;
            } catch (e) {
                alert("الكاميرا مطلوبة"); return;
            }

            video.addEventListener('play', () => {
                const canvas = faceapi.createCanvasFromMedia(video);
                const displaySize = { width: video.width, height: video.height };
                faceapi.matchDimensions(canvas, displaySize);
                
                let checkInterval = setInterval(async () => {
                    const detections = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                    
                    if (detections) {
                        statusTxt.innerText = "جاري التحقق... اثبت";
                        statusTxt.style.color = "#10b981";
                        clearInterval(checkInterval);
                        submitAttendance(detections.descriptor);
                    } else {
                        statusTxt.innerText = "وجهك غير واضح...";
                        statusTxt.style.color = "#ef4444";
                    }
                }, 1000);
            });
        }

        async function submitAttendance(faceVector) {
            const statusTxt = document.getElementById('statusTxt');
            statusTxt.innerText = "جاري الاتصال بالسيرفر...";

            // طلب الرقم الجامعي (لأننا لم نستخدم شاشة إدخال بيانات)
            let studentID = prompt("أدخل رقمك الجامعي للتأكيد:");
            if(!studentID) { location.reload(); return; }
            
            let studentName = studentsDB[studentID] || "غير مسجل (جديد)";
            attendanceData.name = studentName;
            attendanceData.id = studentID;

            const payload = {
                action: "register_identity",
                id: studentID,
                name: studentName,
                hall: document.getElementById('hallSelect').value,
                vector: Array.from(faceVector),
                gps: `${userLat},${userLng}`,
                deviceId: getDeviceId(),
                time: new Date().toLocaleTimeString('en-US')
            };

            try {
                // إرسال للشيت الأمني (Identity)
                const response = await fetch(CONFIG.identitySheetUrl, {
                    method: 'POST', mode: 'cors',
                    headers: {'Content-Type': 'text/plain'},
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                logSystemAlert(result, studentName, studentID); // تسجيل التنبيه محلياً

                if (result.risk === "DEVICE_SHARING" || result.risk === "FACE_SPOOF" || result.risk === "DUPLICATE_ID") {
                    deductAttempt();
                    alert(result.ui_alert.message);
                    location.reload();
                    return;
                }

                // إرسال لشيت الحضور (Attendance)
                const formParams = new URLSearchParams();
                formParams.append("action", "register");
                formParams.append("id", studentID);
                formParams.append("name", studentName);
                formParams.append("hall", payload.hall);
                formParams.append("subject", document.getElementById('subjectSelect').value);
                formParams.append("code", document.getElementById('sessionPass').value);
                
                await fetch(CONFIG.sheetApiUrl, {
                    method: 'POST', mode: 'no-cors',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formParams.toString()
                });

                isProcessActive = false;
                showSuccessScreen(studentName, studentID, payload.hall);

            } catch (e) {
                console.error(e);
                showError("فشل الاتصال بالسيرفر.");
            }
        }

        function showSuccessScreen(name, id, hall) {
            document.getElementById('receiptName').innerText = name;
            document.getElementById('receiptID').innerText = id;
            document.getElementById('receiptHall').innerText = hall;
            document.getElementById('receiptTime').innerText = new Date().toLocaleTimeString('en-US');
            
            if(videoStream) videoStream.getTracks().forEach(t => t.stop());
            switchScreen('screenSuccess');
            document.getElementById('successSound').play();
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        }

        // ============================================================
        // 7. نظام التنبيهات (تعديل 2: تفاصيل إنجليزية)
        // ============================================================
        function logSystemAlert(serverResult, name, id) {
            if (serverResult.status === 'warning') {
                const newAlert = {
                    name: name,
                    id: id,
                    timestamp: new Date().toLocaleString('en-US'), // التاريخ إنجليزي
                    hall: serverResult.system_data.hall || "N/A",
                    reason: serverResult.risk, 
                    details: serverResult.ui_alert.message
                };
                systemAlerts.unshift(newAlert);
                localStorage.setItem(STORAGE_KEYS.ALERTS, JSON.stringify(systemAlerts));
                updateAlertBadge();
            }
        }

        function updateAlertBadge() {
            const badge = document.getElementById('notifBadge');
            badge.style.display = systemAlerts.length > 0 ? 'block' : 'none';
        }

        function showNotificationModal() {
            if (sessionStorage.getItem('DOCTOR_MODE') !== 'true') {
                showToast("خاص بالمسؤولين فقط", 2000, "#ef4444"); return;
            }
            const container = document.getElementById('alertsListContainer');
            container.innerHTML = '';
            
            if (systemAlerts.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:20px; color:#94a3b8;">لا توجد تنبيهات</div>';
            } else {
                systemAlerts.forEach(alert => {
                    let typeClass = '', reasonTag = '';
                    if(alert.reason.includes('REPEAT') || alert.reason.includes('DUPLICATE') || alert.reason.includes('SHARING')) {
                        typeClass = 'type-repeat'; reasonTag = '<span class="alert-reason-badge tag-reason">Fraud/Repeat</span>';
                    } else if (alert.reason.includes('LOCATION')) {
                        typeClass = 'type-far'; reasonTag = '<span class="alert-reason-badge tag-hall">Location</span>';
                    }
                    
                    const html = `
                        <div class="alert-card ${typeClass}">
                            <div class="alert-header">
                                <span class="alert-name">${alert.name}</span>
                                <span class="alert-date" style="font-family:'Outfit'">${alert.timestamp}</span>
                            </div>
                            <div class="alert-meta">
                                <span>ID: ${alert.id}</span>
                                <span>Hall: ${alert.hall}</span>
                            </div>
                            <div class="alert-details">
                                ${reasonTag}
                                <span>${alert.details}</span>
                            </div>
                        </div>`;
                    container.innerHTML += html;
                });
            }
            document.getElementById('identityAlertModal').style.display = 'flex';
        }

        function closeIdentityAlert() { document.getElementById('identityAlertModal').style.display = 'none'; }

        // ============================================================
        // 8. أدوات الإدارة والطلاب (تعديل 5 و 6)
        // ============================================================
        
        // إدارة الطلاب (جديد)
        function openManageStudents() {
            renderManagementList('manageStudentsContent', 'إضافة طالب (محلي)', [], (val) => {
                // دالة إضافة خاصة للطلاب
                const parts = val.split(',');
                if(parts.length >= 2) {
                    studentsDB[parts[0].trim()] = parts[1].trim();
                    localStorage.setItem(STORAGE_KEYS.DB, JSON.stringify(studentsDB));
                    showToast("تم الحفظ", 2000, "#10b981");
                } else { alert("اكتب: الرقم, الاسم"); }
            }, null, 'manageStudentsModal');
            // تعديل Placeholder
            document.getElementById('input_manageStudentsModal').placeholder = "الرقم الجامعي, الاسم الثلاثي";
        }

        // إدارة القاعات
        function openManageHalls() {
            renderManagementList('manageHallsContent', 'إدارة القاعات', hallsList, (val) => {
                hallsList.push(val); localStorage.setItem(STORAGE_KEYS.HALLS, JSON.stringify(hallsList));
                renderHallOptions();
            }, (idx) => {
                hallsList.splice(idx, 1); localStorage.setItem(STORAGE_KEYS.HALLS, JSON.stringify(hallsList));
                renderHallOptions();
            }, 'manageHallsModal');
        }

        // إدارة المواد
        function openManageSubjects() {
            let allSubs = [...subjectsData.first_year, ...subjectsData.second_year];
            renderManagementList('manageSubjectsContent', 'إدارة المواد', allSubs, (val) => {
                subjectsData.first_year.push(val); localStorage.setItem(STORAGE_KEYS.SUBJECTS, JSON.stringify(subjectsData));
            }, (idx) => {
                const v = allSubs[idx];
                subjectsData.first_year = subjectsData.first_year.filter(s => s !== v);
                subjectsData.second_year = subjectsData.second_year.filter(s => s !== v);
                localStorage.setItem(STORAGE_KEYS.SUBJECTS, JSON.stringify(subjectsData));
            }, 'manageSubjectsModal');
        }

        function renderManagementList(containerId, title, dataList, addCallback, deleteCallback, modalId) {
            const container = document.getElementById(containerId);
            let listHtml = dataList.map((item, idx) => `
                <div class="list-item-modern">
                    <span>${item}</span>
                    ${deleteCallback ? `<button class="btn-delete-modern" onclick="handleDelete('${modalId}', ${idx})"><i class="fa-solid fa-trash"></i></button>` : ''}
                </div>
            `).join('');

            container.innerHTML = `
                <div class="close-btn-floating" onclick="document.getElementById('${modalId}').style.display='none'"><i class="fa-solid fa-xmark"></i></div>
                <h3>${title}</h3>
                <div class="manage-card">
                    <div class="manage-input-row">
                        <input id="input_${modalId}" type="text" class="manage-input" placeholder="إضافة جديد...">
                        <button id="btn_add_${modalId}" class="btn-add-modern">إضافة</button>
                    </div>
                </div>
                <div style="max-height:300px; overflow-y:auto;">${listHtml}</div>
            `;
            
            document.getElementById(`btn_add_${modalId}`).onclick = function() {
                const val = document.getElementById(`input_${modalId}`).value;
                if(val) { addCallback(val); document.getElementById(modalId).style.display='none'; setTimeout(()=>eval(`open${modalId.replace('Content','').replace('Modal','')}('')`), 100); }
            };

            window.handleDelete = function(mId, idx) {
                if(confirm("حذف؟")) { deleteCallback(idx); document.getElementById(mId).style.display='none'; setTimeout(()=>eval(`open${mId.replace('Content','').replace('Modal','')}('')`), 100); }
            };
            document.getElementById(modalId).style.display = 'flex';
        }

        // ============================================================
        // 9. التقارير والتحديث الذكي (تعديل 3)
        // ============================================================
        async function openReportModal() {
            document.getElementById('reportModal').style.display = 'flex';
            currentReportView = 'subjects';
            refreshCurrentReport();
        }

        async function refreshCurrentReport() {
            const d = new Date().toLocaleDateString('en-GB');
            document.getElementById('reportDateDisplay').innerText = d;
            
            // إذا كنا في الصفحة الرئيسية، نجلب البيانات
            if (currentReportView === 'subjects') {
                const container = document.getElementById('subjectsContainer');
                container.innerHTML = `<div style="text-align:center; padding:50px;"><i class="fa-solid fa-circle-notch fa-spin" style="font-size:30px; color:var(--primary);"></i></div>`;
                try {
                    const response = await fetch(`${CONFIG.sheetApiUrl}?action=getReport&date=${encodeURIComponent(d)}`);
                    const data = await response.json();
                    cachedReportData = data.reverse();
                    renderSubjectsList(cachedReportData);
                } catch (e) { container.innerHTML = '<div style="color:red; text-align:center;">خطأ في الاتصال</div>'; }
            } 
            // إذا كنا داخل مادة أو قاعة، نعيد الريندر فقط
            else if (currentReportView === 'halls') {
                openSubjectDetails(currentSelectedSubject);
            } 
            else if (currentReportView === 'students') {
                openHallDetails(currentSelectedSubject, currentSelectedHall);
            }
        }

        function renderSubjectsList(data) {
            const subjects = [...new Set(data.map(item => item.subject || "غير محدد"))];
            let html = '';
            subjects.forEach(subject => {
                const count = data.filter(i => i.subject === subject).length;
                html += `<div class="subject-big-card" onclick="currentSelectedSubject='${subject}'; openSubjectDetails('${subject}')">
                            <div class="sub-card-info"><h3>${subject}</h3><span><i class="fa-solid fa-users"></i> الحضور: ${count}</span></div>
                            <div class="sub-arrow"><i class="fa-solid fa-chevron-left"></i></div>
                         </div>`;
            });
            document.getElementById('subjectsContainer').innerHTML = html;
            showView('viewSubjects');
        }

        function openSubjectDetails(subject) {
            currentReportView = 'halls';
            currentSelectedSubject = subject;
            const filtered = cachedReportData.filter(s => s.subject === subject);
            const halls = [...new Set(filtered.map(item => item.hall || "N/A"))];
            let html = `<div class="students-list-header"><button onclick="currentReportView='subjects'; showView('viewSubjects')" class="btn-back-report"><i class="fa-solid fa-arrow-right"></i></button><span style="font-weight:bold;">${subject}</span></div>`;
            
            halls.forEach(hall => {
                const count = filtered.filter(i => i.hall === hall).length;
                html += `<div class="hall-big-card" onclick="currentSelectedHall='${hall}'; openHallDetails('${subject}', '${hall}')">
                            <div class="sub-card-info"><h3 style="color:#059669">${hall}</h3><span><i class="fa-solid fa-check"></i> ${count}</span></div>
                            <div class="sub-arrow"><i class="fa-solid fa-chevron-left"></i></div>
                         </div>`;
            });
            document.getElementById('hallsContainer').innerHTML = html;
            showView('viewHalls');
        }

        function openHallDetails(subject, hall) {
            currentReportView = 'students';
            const students = cachedReportData.filter(s => s.subject === subject && (s.hall||"N/A") === hall);
            let html = `<div class="students-list-header"><button onclick="currentReportView='halls'; showView('viewHalls')" class="btn-back-report"><i class="fa-solid fa-arrow-right"></i></button>
                        <div style="text-align:right;"><span style="font-size:10px; display:block;">${subject}</span><span style="font-weight:bold;">${hall}</span></div></div>`;
            
            students.forEach(item => {
                html += `<div class="student-detailed-card">
                            <div style="display:flex; justify-content:space-between;">
                                <div style="font-weight:bold;">${item.name}</div>
                                <div style="font-family:'Outfit'; color:#64748b;">${item.time}</div>
                            </div>
                            <div style="font-size:11px; color:#64748b;">ID: ${item.uniID}</div>
                         </div>`;
            });
            document.getElementById('studentsContainer').innerHTML = html;
            showView('viewStudents');
        }

        function showView(viewId) {
            ['viewSubjects', 'viewHalls', 'viewStudents'].forEach(v => {
                const el = document.getElementById(v);
                if(v === viewId) { el.style.transform = 'translateX(0)'; }
                else { el.style.transform = 'translateX(100%)'; } // إزاحة لليمين
            });
            // إصلاح خاص للأول
            if(viewId === 'viewSubjects') document.getElementById('viewSubjects').style.transform = 'translateX(0)';
        }

        // ============================================================
        // 10. أدوات مساعدة (Utilities)
        // ============================================================
        function switchScreen(id) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            // الأزرار العائمة للمسؤول
            const adminBack = document.getElementById('adminFloatingBack');
            const isAdmin = sessionStorage.getItem('DOCTOR_MODE') === 'true';
            if (isAdmin && id !== 'screenWelcome' && id !== 'screenAdminLogin') { adminBack.style.display = 'flex'; } else { adminBack.style.display = 'none'; }
        }

        function getDeviceId() {
            let id = localStorage.getItem('device_id');
            if(!id) { id = 'DEV_' + Math.random().toString(36).substr(2, 9); localStorage.setItem('device_id', id); }
            return id;
        }

        function showToast(msg, duration, color) {
            const div = document.createElement('div');
            div.style.cssText = `position:fixed; bottom:30px; left:50%; transform:translateX(-50%); background:${color}; color:white; padding:12px 25px; border-radius:30px; z-index:999999; font-weight:bold; box-shadow:0 5px 20px rgba(0,0,0,0.2); animation:fadeIn 0.3s;`;
            div.innerHTML = msg;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), duration);
        }

        function checkAdminPassword() {
            if (document.getElementById('adminPassword').value === CONFIG.adminPassword) {
                sessionStorage.setItem('DOCTOR_MODE', 'true');
                document.getElementById('adminPassword').value = '';
                updateUIForMode();
                switchScreen('screenWelcome');
                showToast("أهلاً بك يا دكتور", 2000, "#10b981");
            } else { showToast("كلمة المرور خاطئة", 2000, "#ef4444"); }
        }

        function performLogout() {
            sessionStorage.removeItem('DOCTOR_MODE');
            updateUIForMode();
            location.reload();
        }

        function updateUIForMode() {
            const isAdmin = sessionStorage.getItem('DOCTOR_MODE') === 'true';
            document.getElementById('adminBadge').style.display = isAdmin ? 'block' : 'none';
            document.getElementById('btnLoginConfig').style.display = isAdmin ? 'none' : 'flex';
            const display = isAdmin ? 'flex' : 'none';
            document.getElementById('btnLogoutConfig').style.display = display;
            document.getElementById('btnExamsConfig').style.display = display;
            document.getElementById('btnRefreshConfig').style.display = display;
            document.getElementById('btnDataEntryConfig').style.display = display;
            const btnReport = document.getElementById('btnReportConfig');
            if(isAdmin) btnReport.classList.remove('locked'); else btnReport.classList.add('locked');
        }

        function openDataEntryMenu() { document.getElementById('dataEntryModal').style.display = 'flex'; }
        
        // إعداد القوائم المنسدلة
        function setupSelectListeners() {
            renderHallOptions();
            const yearOptions = document.querySelectorAll('#yearSelectWrapper .custom-option');
            yearOptions.forEach(opt => {
                opt.addEventListener('click', function() {
                    const val = this.getAttribute('data-value');
                    document.getElementById('yearSelect').value = val;
                    updateTriggerText('yearSelectWrapper', this.innerText);
                    renderSubjectOptions(val);
                });
            });
        }

        function renderHallOptions() {
            const container = document.getElementById('hallOptionsContainer');
            container.innerHTML = '';
            hallsList.forEach(h => {
                const div = document.createElement('div');
                div.className = 'custom-option';
                div.innerHTML = `<span>${h}</span>`;
                div.onclick = function() {
                    document.getElementById('hallSelect').value = h;
                    updateTriggerText('hallSelectWrapper', h);
                    checkAllConditions();
                };
                container.appendChild(div);
            });
        }

        function renderSubjectOptions(year) {
            const container = document.getElementById('subjectOptionsContainer');
            const wrapper = document.getElementById('subjectSelectWrapper');
            container.innerHTML = '';
            if (subjectsData[year]) {
                wrapper.classList.remove('disabled');
                subjectsData[year].forEach(s => {
                    const div = document.createElement('div');
                    div.className = 'custom-option';
                    div.innerHTML = `<span>${s}</span>`;
                    div.onclick = function() {
                        document.getElementById('subjectSelect').value = s;
                        updateTriggerText('subjectSelectWrapper', s);
                        checkAllConditions();
                    };
                    container.appendChild(div);
                });
            } else { wrapper.classList.add('disabled'); }
        }

        function updateTriggerText(wrapperId, text) {
            const wrapper = document.getElementById(wrapperId);
            wrapper.querySelector('.trigger-text').innerText = text;
            wrapper.classList.remove('open');
            wrapper.querySelectorAll('.custom-option').forEach(o => o.classList.remove('selected'));
        }

        function closeSelect(overlay) { overlay.parentElement.classList.remove('open'); }
        function closeSelectFromBtn(btn) { btn.closest('.custom-select-wrapper').classList.remove('open'); event.stopPropagation(); }

        document.querySelectorAll('.custom-select-trigger').forEach(trigger => {
            trigger.addEventListener('click', function() {
                const wrapper = this.parentElement;
                if(!wrapper.classList.contains('disabled')) {
                    document.querySelectorAll('.custom-select-wrapper').forEach(w => w !== wrapper && w.classList.remove('open'));
                    wrapper.classList.toggle('open');
                }
            });
        });
        
        // بحث القاعات
        document.getElementById('hallSearchInput').addEventListener('input', function(e) {
            const val = e.target.value;
            const container = document.getElementById('hallOptionsContainer');
            container.innerHTML = '';
            const filtered = hallsList.filter(h => h.includes(val));
            filtered.forEach(h => {
                const div = document.createElement('div'); div.className = 'custom-option'; div.innerHTML = `<span>${h}</span>`;
                div.onclick = function() {
                    document.getElementById('hallSelect').value = h;
                    updateTriggerText('hallSelectWrapper', h);
                    checkAllConditions();
                };
                container.appendChild(div);
            });
        });
    </script>
</body>
</html>
